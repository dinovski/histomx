---
title: "&nbsp;v1.9"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    keep_md: no
    includes:
        before_body: histomx_header.html
        after_body: histomx_footer.html
params:
  rcc_file: 'missing-filename'
  rna_file: ''
  patient_file: ''
---

<style type="text/css">
  body{font-size: 10pt;}
</style>

```{r, include=FALSE, eval=FALSE}
## to run manually
newRCC='../test_files/test.RCC'
rmarkdown::render('../scripts/histomx_kidney.Rmd')
## convert output html to paged PDF 
system('wkhtmltopdf --javascript-delay 1 ~/Desktop/histomx_report.html ~/Desktop/histomx_report.pdf')
```

```{r setup, include=FALSE, echo=FALSE}
options(rgl.useNULL=TRUE)
## set paths in all code chunks are relative to this root.dir
rdir=getwd()
knitr::opts_knit$set(rdir)

library(htmltools, quietly=TRUE)
library(ggplot2, quietly=TRUE)
theme_set(theme_minimal())
library(gridExtra, quietly=TRUE)
library(knitr, quietly=TRUE)
opts_knit$set(eval.after = "fig.cap")
library(kableExtra, quietly=TRUE)
knitr::opts_chunk$set(echo = TRUE)
```

***
## Molecular Pathology Platform
> **Team leader:** Pr Alexandre Loupy MD/PhD  
**Project managers:** Fariza Mezine & Dina Zielinski PhD  
**Clinical reviewer:** Olivier Aubert MD/PhD    
**Contact:** jessy.dagobert@inserm.fr / +33-1-53-98-80-85  
> Inserm U970 - 56 rue Leblanc 75015 Paris, France

```{r, echo=FALSE, warning=FALSE, include=FALSE, eval=TRUE}
source('../scripts/BHOTpred.R')
```

```{r, echo=FALSE, warning=FALSE, include=FALSE, eval=TRUE}
## import parameters (list of input files)
## see render-rmarkdown.sh to run markdown with new RCC as input
newPatient <- params$patient_file
newRNA <- params$rna_file
newRCC <- params$rcc_file

newPath <- normalizePath(dirname(newRCC))
dir.create(paste0(newPath, '/histomx_results/'), recursive=TRUE, showWarnings=FALSE)
outPath=paste0(newPath, '/histomx_results/')

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
## the following functions output all files to a directory called 'histomx_results' in the input file path
newPreds <- BHOTpred(newRCC, outPath, saveFiles=FALSE)
newID <- newPreds$new_scores$ID

newQC <- rccQC(newRCC, outPath)

```

***
## Sample info:
```{r, echo=FALSE, warning=FALSE, message=FALSE, include=TRUE}

## check if sample info exists; check file type (json or txt) and import
if(!is.na(file.info(newPatient)$size)) {
  
	if (tools::file_ext(newPatient) == "json") {
		jfile <- fromJSON(file=newPatient)
		pt_df <- as.data.frame(jfile, check.names=F)
	} else if (tools::file_ext(newPatient) == "txt") {
		pt_df <- read.table(newPatient, sep='\t', na.strings=c("", "NA"))
	} else {
		stop("Sample info file must be a .json or tab delimited .txt file")
	}	
	
	## if file contains no info, display empty data frame
	if (empty(pt_df)==TRUE) {
		
		pt_df <- data.frame('Platform ID'=newPreds$new_scores$ID,
                        'Date of transplantation'=" ", 'Date of biopsy'=" ",
                        'Biopsy indication'="    ", check.names=FALSE)
		pt_df <- data.frame(V1=rownames(t(pt_df)), V2=t(pt_df)[,1])
	} else {
		## exclude empty cells
		pt_df <- pt_df %>% filter_all(all_vars(!is.na(.)))
	}

      
} else {
	## if no file, display empty data frame
	pt_df <- data.frame('Platform ID'=newPreds$new_scores$ID,
                        'Date of transplantation'=" ", 'Date of biopsy'=" ",
                        'Biopsy indication'="    ", check.names=FALSE)
	pt_df <- data.frame(V1=rownames(t(pt_df)), V2=t(pt_df)[,1])
}

## format and output patient info table
if(nrow(pt_df) %% 2 == 0) {
    pt_df <- cbind(pt_df[1:(nrow(pt_df)/2),], pt_df[(nrow(pt_df)/2+1):nrow(pt_df),])
    kable(pt_df, row.names=FALSE, col.names=rep("", ncol(pt_df)), align='c', format="html") %>%
          row_spec(1:nrow(pt_df), background="white") %>%
          column_spec(c(1,3), bold=TRUE, background="whitesmoke")
} else {
    ## todo: set 1st row as single row, remaining as double
    kable(pt_df, row.names=FALSE, col.names=rep("", ncol(pt_df)), align='c', format="html") %>%
    row_spec(1:nrow(pt_df), background="white") %>%
    column_spec(1, bold=TRUE, background="whitesmoke")
}

```

\newpage

***
## Gene expression based probabilities
***
### Diagnosis based probabilities (%):
```{r, echo=FALSE, warning=FALSE, message=FALSE, include=TRUE}

## molecular score table
ms_new <- data.frame(t(newPreds$new_scores[,c("amr", "tcmr", "normal", "other")]), check.names=FALSE)
ms_new$Diagnosis <- rownames(ms_new)

## confidence intervals
ci_tab <- data.frame(newPreds$new_scores[,grep("_ci", names(newPreds$new_scores))])
ci_new <- data.frame(amr=paste(ci_tab$amr_lwr_ci, "-", ci_tab$amr_upr_ci),
		     tcmr=paste(ci_tab$tcmr_lwr_ci, "-", ci_tab$tcmr_upr_ci),
		     normal=paste(ci_tab$normal_lwr_ci, "-", ci_tab$normal_upr_ci),
		     other=paste(ci_tab$other_lwr_ci, "-", ci_tab$other_upr_ci))
ci_new <- data.frame(CI=t(ci_new))
ci_new$Diagnosis <- rownames(ci_new)

## reference set quantiles
ms_ref <- newPreds$ref_scores[,c("Dx", "amr", "tcmr", "normal", "other", "Q")]
 
## q1 and q3 (can also add IQR, min, max)
tab <- data.frame(matrix(nrow=dim(ms_new)[1], ncol=2), check.names=FALSE)
colnames(tab) <- c("No rejection Q1", "No rejection Q3")
rownames(tab) <- rownames(ms_new)

## rows=molecular scores; columns=histo diagnosis
## reference biopsy AMR molecular score ranges
tab[rownames(tab)=="amr","No rejection Q1"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="25%","amr"]
tab[rownames(tab)=="amr","No rejection Q3"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="75%","amr"]

## reference biopsy TCMR molecular score ranges
tab[rownames(tab)=="tcmr","No rejection Q1"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="25%","tcmr"]
tab[rownames(tab)=="tcmr","No rejection Q3"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="75%","tcmr"]

## reference biopsy Nonrejection molecular score ranges
tab[rownames(tab)=="normal","No rejection Q1"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="25%","normal"]
tab[rownames(tab)=="normal","No rejection Q3"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="75%","normal"]

## reference biopsy non-rejection related injury molecular score ranges
tab[rownames(tab)=="other","No rejection Q1"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="25%","other"]
tab[rownames(tab)=="other","No rejection Q3"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="75%","other"]

tab$'Normal range' <- paste(tab$`No rejection Q1`, "-", tab$`No rejection Q3`)
tab$'Diagnosis' <- rownames(tab)
tab <- merge(tab, ci_new, by="Diagnosis")

dx_tab <- merge(ms_new, tab[,c("Diagnosis", "CI", "Normal range")], by="Diagnosis")
colnames(dx_tab)[colnames(dx_tab)=="CI"]<-paste(newID, "range")

dx_order <- c("amr", "tcmr", "normal", "other")
dx_tab <- dx_tab %>% dplyr::slice(match(dx_order, Diagnosis))
dx_tab <- dx_tab[!dx_tab$Diagnosis %in% "normal",]
dx_tab$Diagnosis[dx_tab$Diagnosis=="amr"]<-"AMR"
dx_tab$Diagnosis[dx_tab$Diagnosis=="tcmr"]<-"TCMR"
dx_tab$Diagnosis[dx_tab$Diagnosis=="other"]<-"NRKI"
#dx_tab <- dx_tab %>% relocate('Diagnosis', .before = colnames(dx_tab)[1])

#TODO: scale probabilities relative to normal biopsies (eg. +/- SD)
dx_tab$Interpretation <- ifelse(dx_tab[,newID]<=10,"unlikely",
                                       ifelse(dx_tab[,newID]>10 & dx_tab[,newID]<=20,"low probability",
                                              ifelse(dx_tab[,newID]>20 & dx_tab[,newID]<=40,"moderate probability",
                                                     ifelse(dx_tab[,newID]>40 & dx_tab[,newID]<=60,"moderate/high probability",
                                                           ifelse(dx_tab[,newID]>60 & dx_tab[,newID]<=80,"high probability",
                                                                  ifelse(dx_tab[,newID]>80,"very high probability","NA"))))))

kable(dx_tab, row.names=FALSE, align='c', caption="", format="html") %>%
    column_spec(1, bold=TRUE, color="black") %>%
    column_spec(c(2,3), bold=TRUE, color="dodgerblue") %>%
    row_spec(1, background="whitesmoke") %>% row_spec(2, background="white")

```
Diagnosis based scores represent the probability that a biopsy has an expression profile similar to reference samples with a given histology based diagnosis. Outcomes include the following: AMR, TCMR, NRKI (non-rejection kidney injury), No rejection or injury diagnosis. The sample range is the confidence interval for the ensemble score.

### Banff lesion based probabilities (%):
```{r, echo=FALSE, warning=FALSE, message=FALSE, include=TRUE, fig.align='center', fig.width=6, fig.height=5}
banff_preds <- data.frame(t(newPreds$new_scores))
banff_tab <- data.frame(lesion=c("g", "ptc", "i", "t"))
banff_tab$'0' <- as.numeric(banff_preds[c("g0", "ptc0", "i0", "t0"),])
banff_tab$'1' <- as.numeric(banff_preds[c("g1", "ptc1", "i1", "t1"),])
banff_tab$'2' <- as.numeric(banff_preds[c("g2", "ptc2", "i2", "t2"),])
banff_tab$'3' <- as.numeric(banff_preds[c("g3", "ptc3", "i3", "t3"),])
rownames(banff_tab) <- banff_tab$lesion

banff.df <- data.table::melt(banff_tab)
banff.df$lesion <- factor(banff.df$lesion, levels=c("t", "i", "ptc", "g"))
banff.df$variable <- factor(banff.df$variable, levels=c("0", "1", "2", "3"))
my_cols=c("steelblue4", "steelblue", "lightblue", "lightcyan")

ggplot(banff.df, aes(x=variable, y=lesion, size=value)) + xlab("") + ylab("") +
	geom_point(aes(fill=value), pch=21, colour="azure4", alpha=1) +
	scale_size(range = c(0, 30), name="%", guide="none") + #increase relative bubble size
	scale_fill_gradientn(colours=rev(my_cols), limits=c(0,100)) +
	theme(panel.grid.major = element_line(colour = "#d3d3d3"), panel.grid.minor=element_blank(),
	      panel.background=element_blank(), axis.line=element_line(colour="white"),
	      axis.text=element_text(size=18, color="navy"),
	      axis.title.x=element_text(size=18, color="navy"), 
	      axis.title.y=element_text(size=18, color="navy"),
	      legend.title=element_blank(),
	      legend.text=element_text(size=14, color="darkslateblue"), legend.key.size = unit(1, 'cm'),
	      panel.border=element_rect(colour="gray", fill=NA, size=1))

## cumulative probability
banff_tab$'< 1' <- banff_tab$'0'
banff_tab$'< 2' <- banff_tab$'0' + banff_tab$'1'
banff_tab$'< 3' <-  banff_tab$'0' + banff_tab$'1' + banff_tab$'2'

kable(banff_tab[,c("lesion", "< 1", "< 2", "< 3")], row.names=FALSE, align='c', format="html") %>%
    column_spec(1, bold=TRUE, color="black") %>%
    row_spec(c(1,3), background="whitesmoke") %>% row_spec(c(2,4), background="white")
```
The above Banff lesion based scores represent the probability for each score and each lesion.

\newpage

### Banff lesion based probabilities (%):
```{r, echo=FALSE, warning=FALSE, message=FALSE, include=TRUE}
## new sample molecular scores
ms_new <- data.frame(t(newPreds$new_scores[,c("cg0_binary", "iifta0_binary", "v0_binary", "cv1_binary", "ci1_binary", "ct1_binary")]), check.names=FALSE)
rownames(ms_new) <- gsub("\\_binary", "", rownames(ms_new))
ms_new$lesion <- rownames(ms_new)
	
## reference set quantiles: newPreds$ref_scores
ms_ref <- newPreds$ref_scores[,c("Dx", "cg0_binary", "iifta0_binary", "v0_binary", "cv1_binary", "ci1_binary", "ct1_binary", "Q")]
colnames(ms_ref) <- gsub("\\_binary", "", colnames(ms_ref))
ms_ref <- ms_ref[ms_ref$Dx != "OTHER",]

## q1 and q3 (can also add IQR, min, max)
tab <- data.frame(matrix(nrow=dim(ms_new)[1], ncol=length(unique(ms_ref$Dx))*2), check.names=FALSE)
colnames(tab) <- c("AMR Q1", "AMR Q3", "TCMR Q1", "TCMR Q3",
                   "NONREJECTION Q1", "NONREJECTION Q3", "NRKI Q1", "NRKI Q3")
rownames(tab) <- rownames(ms_new)

## add reference biopsy molecular score ranges
## rows=molecular scores; columns=histo diagnosis
for(i in 1:nrow(tab)) {
  tab[rownames(tab)==rownames(ms_new)[i],"AMR Q1"] <- ms_ref[ms_ref$Dx=="AMR" & ms_ref$Q=="25%",rownames(ms_new)[i]]
  tab[rownames(tab)==rownames(ms_new)[i],"AMR Q3"] <- ms_ref[ms_ref$Dx=="AMR" & ms_ref$Q=="75%",rownames(ms_new)[i]]
  tab[rownames(tab)==rownames(ms_new)[i],"TCMR Q1"] <- ms_ref[ms_ref$Dx=="TCMR" & ms_ref$Q=="25%",rownames(ms_new)[i]]
  tab[rownames(tab)==rownames(ms_new)[i],"TCMR Q3"] <- ms_ref[ms_ref$Dx=="TCMR" & ms_ref$Q=="75%",rownames(ms_new)[i]]
  tab[rownames(tab)==rownames(ms_new)[i],"NONREJECTION Q1"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="25%",rownames(ms_new)[i]]
  tab[rownames(tab)==rownames(ms_new)[i],"NONREJECTION Q3"] <- ms_ref[ms_ref$Dx=="NONREJECTION" & ms_ref$Q=="75%",rownames(ms_new)[i]]
  tab[rownames(tab)==rownames(ms_new)[i],"NRKI Q1"] <- ms_ref[ms_ref$Dx=="NRKI" & ms_ref$Q=="25%",rownames(ms_new)[i]]
  tab[rownames(tab)==rownames(ms_new)[i],"NRKI Q3"] <- ms_ref[ms_ref$Dx=="NRKI" & ms_ref$Q=="75%",rownames(ms_new)[i]]
}

tab$'Normal range' <- paste(tab$`NONREJECTION Q1`, "-", tab$`NONREJECTION Q3`)
tab$'lesion' <- rownames(tab)

if(!all(rownames(ms_new)==rownames(tab))) {
  stop("check concordance of lesion score names between new sample and refset")
}

tab <- merge(ms_new, tab, by="lesion")

tab$Interpretation <- ifelse(tab[,newID]<=10,"unlikely",
                                       ifelse(tab[,newID]>10 & tab[,newID]<=20,"low probability",
                                              ifelse(tab[,newID]>20 & tab[,newID]<=40,"moderate probability",
                                                     ifelse(tab[,newID]>40 & tab[,newID]<=60,"moderate/high probability",
                                                           ifelse(tab[,newID]>60 & tab[,newID]<=80,"high probability",
                                                                  ifelse(tab[,newID]>80,"very high probability","NA"))))))

## return range for 'normal' biopsies
ref_quantiles <- tab[,c(newID, "lesion", "Normal range", "Interpretation")]

ref_quantiles$'lesion' <- gsub("0", " > 0", ref_quantiles$'lesion')
ref_quantiles$'lesion' <- gsub("1", " > 1", ref_quantiles$'lesion')

ref_quantiles <- ref_quantiles %>% relocate('lesion', .before = colnames(ref_quantiles)[1])
#ref_quantiles <- ref_quantiles[order(ref_quantiles[,newID], decreasing=TRUE),]

kable(ref_quantiles, row.names=FALSE, align='c', format="html") %>%
    column_spec(1, bold=TRUE, color="black") %>%
    column_spec(2, bold=TRUE, color="dodgerblue") %>%
    row_spec(c(1,3,5), background="whitesmoke") %>% row_spec(c(2,4,6), background="white")

#Ranges are defined by Q1 and Q3, the upper and lower bounds of the middle 50% of the reference biopsy molecular scores for each histology based diagnosis.
```
The above Banff lesion based scores represent the probability that a biopsy has a score >0 or >1, as indicated for each lesion: unlikely (<10%), low (10-20%), moderate (20-40%), moderate/high (40-60%), high (60-80%), very high (80-100%).

***
## Principal Components Analysis (PCA) of molecular scores:
<div style="margin-bottom:10px;">
```{r, echo=FALSE, warning=FALSE, comment=FALSE, results='asis', fig.align='center', fig.cap='Samples are labeled by histologic diagnosis. The tested sample is the yellow diamond.'}

#gridExtra::grid.arrange(newPreds$pca_1_2, newPreds$pca_2_3, ncol=2)
newPreds$pca_1_2
#newPreds$pca_2_3

```
</div>

### Histologic Diagnosis of 25 Nearest Neighbors
```{r, echo=FALSE, warning=FALSE, results='asis', eval=TRUE}
newPreds$knn_dx$Dx <- rownames(newPreds$knn_dx)
newPreds$knn_dx <- newPreds$knn_dx[,c("Dx", "Total", "Percent")]

kable(newPreds$knn_dx, row.names=FALSE, align='c', caption="", format="html") %>%
    column_spec(c(1,2,3), bold=TRUE, background="white")
```

```{r, echo=FALSE, warning=FALSE, results='asis', eval=FALSE}
### Banff scores of 25 Nearest Neighbors (%)
newPreds$knn_banff$score <- rownames(newPreds$knn_banff)
newPreds$knn_banff <- newPreds$knn_banff[,c("score", "g", "ptc", "cg", "i", "t")]

kable(newPreds$knn_banff, row.names=FALSE, align='c', caption="", format="html") %>%
    column_spec(c(1,2,3,4,5,6), bold=TRUE, background="white")
```

\newpage

***
### Clinician signout
```{r, echo=FALSE, warning=FALSE, include=TRUE}
sign_df <- data.frame(Name=">", Signature="")

kable(sign_df, align='c', format="html") %>% kableExtra::kable_styling(position="center") %>%
  row_spec(1, background="white", align='l')
```
> **_Comments:_**  
>  &nbsp;    
>  &nbsp;  
>  &nbsp;  
>  &nbsp;    
>  &nbsp;  

\newpage

***
## Technical details
***

### RNA quality
```{r, echo=FALSE, warning=FALSE, include=TRUE}

if(!is.na(file.info(newRNA)$size)) {
  
  	if (tools::file_ext(newRNA) == "json") {
		jfile <- fromJSON(file=newRNA)
		rna_df <- as.data.frame(jfile, check.names=F)
	} else if (tools::file_ext(newRNA) == "txt") {
		rna_df <- read.table(newRNA, check.names=F, sep='\t')
	} else {
		stop("Sample info file must be a .json or tab delimited .txt file")
	}	

	## transpose and use first column as header
	if(nrow(rna_df) > 2) {
		rna_df <- setNames(data.frame(t(rna_df[,-1])), rna_df[,1])
	}

	## if units (ng/ul) included in RNA concentration strip; else convert to numeric
	if(length(strsplit(rna_df$concentration, " ")[[1]]) > 1) {
		rna_df$concentration <- as.numeric(strsplit(rna_df$concentration, " ")[[1]][1])
	} else {
		rna_df$concentration <- as.numeric(rna_df$concentration)
	}

	## move concentration to end
	rna_df <- rna_df %>% relocate(concentration, .after=last_col())

	## apply threshold based text color and add back units
	if(rna_df$concentration >= 20) {
		rna_df$status <- "Passed"
		rna_df$concentration <- paste(rna_df$concentration, "ng/ul")
		status_color="green"
	} else if(rna_df$concentration>=10 & rna_df$concentration<20) {
		rna_df$status <- "Caution"
		rna_df$concentration <- paste(rna_df$concentration, "ng/ul")
		status_color="goldenrod"
	} else if(rna_df$concentration < 10) {
		rna_df$status <- "Warning"
		rna_df$concentration <- paste(rna_df$concentration, "ng/ul")
		status_color="firebrick"
	}

	kable(rna_df, row.names=FALSE, align='c', caption="", format="html") %>%
	column_spec(1, bold=TRUE, color="dodgerblue") %>%
	column_spec(ncol(rna_df), bold=TRUE, color=status_color) %>%
	row_spec(1, background="white")
  
} else {
	## display empty data frame
	rna_df <- data.frame(ID=newPreds$new_scores$ID, '260/280 ratio'="", '260/230 ratio'="",
                       concentration="", status="", check.names=FALSE)
  
	kable(rna_df, row.names=FALSE, align='c', caption="", format="html") %>%
	column_spec(1, bold=TRUE, color="dodgerblue") %>%
	column_spec(ncol(rna_df), bold=TRUE) %>%
	row_spec(1, background="white")
}

```
"Caution" status indicates a concentration within the minimum recommended 10-20ng/ul range  
"Warning" status indicates a concentration lower than the recommended minimum 10ng/ul

### NanoString run information
```{r, echo=FALSE, warning=FALSE, include=TRUE}
newQC$qc_table$variable <- rownames(newQC$qc_table)
#newQC$qc_table <- newQC$qc_table[!rownames(newQC$qc_table) %in% "POS_E counts",]

qcTab <- newQC$qc_table
colnames(qcTab) <- c(newID, "variable")
qcTab <- qcTab[!qcTab$variable %in% c("FovCount", "FovCounted", "ncgMean", "ncgSD", "FileVersion"),]

qcTab <- cbind(qcTab[1:(nrow(qcTab)/2),], qcTab[(nrow(qcTab)/2+1):nrow(qcTab),])

kable(qcTab, row.names=FALSE, col.names=rep("", ncol(qcTab)), align='l', caption="", format="html") %>%
  column_spec(c(1,3), bold=TRUE, background="whitesmoke") %>%
  column_spec(c(2,4), background="white")

#The version of the RLF file must match the version of the CodeSet used in the hybridization
#counts of POS_E should be higher than 2x the SD above the mean of the negative control
#https://www.nanostring.com/wp-content/uploads/2020/12/Gene_Expression_Data_Analysis_Guidelines.pdf
```
FoV=fields of view; geo mean=geometric mean; LoD=limit of detection; PCL=positive control linearity

__Recommended thresholds:__  
FoV >75%  
Binding density 0.05 to 2.25  
PCL > 0.95  
80% ENDO genes > LoD  
POS_E counts should be > LoD

### For research use only
Models have not been validated in clinical settings or trials. This report does not replace a standard diagnosis. Due to known technical variation, RNA later-fixed samples should be interpreted with caution.

```{r, echo=FALSE, include=TRUE}
#logoIMG='../static/multi-logos.png'
logoIMG='../static/ptg-logo.png'

htmltools::img(src = knitr::image_uri(logoIMG), 
               alt = 'logo', 
               style="display: block; margin-left: auto; margin-right: auto;")
```

